# Pantos scripts documentation

One can use the Pantos scripts in the following cases:

1. To do a deployment from scratch or update configurations of the system.
    1. To do a deployment from scratch, use the ```DeployContracts.s.sol``` and ```RegisterExternalTokens.s.sol``` scripts.
    2. To update the fee factors, use the ```UpdateFeeFactors.s.sol```.
2. To redeploy a contract which is part of the Pantos system.
    1. PantosHub redeployment: If the PantosHub has changes, it is important to understand if those changes lead to storage collision (https://docs.openzeppelin.com/upgrades-plugins/1.x/proxies#storage-collisions-between-implementation-versions).
        1. If the PantosHub suffers storage collision, use the ```redeploy/RedeployHub.s.sol``` script.
        2. If the PantosHub did not suffer storage collision, use the ```redeploy/UpgradeHub.s.sol``` script.
    2. PantosForwarder redeployment. Use the ```redepoy/PantosForwarder.s.sol``` script.
    3. PantosHub and PantosForwarder redeployment (at the same time).
        1. If the PantosHub suffers storage collision, use the ```redeploy/RedeployHubAndForwarder.s.sol``` script.
        2. If the PantosHub did not suffer storage collision, use the ```redeploy/UpgradeHubAndRedeployForwarder.s.sol``` script.

## How to run the scripts in a non-local environment

#### Important! Please read before using the scripts in non-local environments:

* Please use the ```--force``` and ```--slow``` options. 
    * The ```--force```option is necessary for clearing the cache of previous deployments on other chains, which might affect new ones. We experienced issues when using the scripts without these options. 
    * The ```--slow``` option is necessary to ensure that previously sent transactions are confirmed before sending new ones.
* If you encounter an error while broadcasting the transactions, please remove the ```--force``` flag and execute the script again with the ```--resume``` option. This can and should be done multiple times (in case of further errors) until all the transactions are successfully broadcasted.
* We keep records of executed scripts in non-local environments at ```./deployment/<env>/<blockchainName>/<executedScript>/```. Each executing should add 2 records: ```run-<YYYYMMDD>.json``` and ```run-<YYYYMMDD>.logs```.
    * The ```.json``` files contains broadcast information automatically generated by ```forge``` when running the scripts. This can be found at ```./broadcast/<executedScript>/<chainId>/run-<identifier>.json```. If the script was executed multiple times using the ```--resume``` flag, one can copy only the latest generated ```run-<identifier>.json``` file (```forge``` automatically merges all the broadcast information into a single file, even if ```--resume``` was used).
    * The ```.logs``` files contain logs generated (in the console) by the executed script. The logs should be copied from the console and pasted into the target file. Please remove any personal information (local user paths) from the logs.

#### Instructions:

1. To run the scripts in a non-local environment, please use the format specified in the ```@dev Usage``` section of the specific script.
2. It is strongly recommended to perform a dry run before broadcasting the transactions. By default, ```forge script``` creates a fork of the blockchain and does a dry run. The scripts emit logs that should be checked before broadcasting the transactions.
3. If the logs are as expected, the transactions can now be broadcasted on the blockchain. In order to achieve this, one needs to add the ```--broadcast``` flag.
4. As a final step, we need to update the ```./deployment/<blockchainName>/<executedScript>/``` records according to the specifications in the above section.

## How to run the scripts in a local environment with Anvil:

The examples run the scripts on a fork of a local blockchain.
* To run the script on a fork of another blockchain, use the flag ```--rpc-url <rpcAlias>```. The aliases can be found in  ```foundry.toml```.
* To broadcast the transactions, use the flag ```--broadcast```.
* To force compilation of all contracts, use the flag ```--force```.

For local testing, one can set up two developement blockchains with anvil:

```bash
anvil --port 8545 --chain-id 31337
```
```bash
anvil --port 8546 --chain-id 31338
```

Copy and add one of the private key (always same in default mode) from anvil network terminal and import it as a keystore using cast cli:

```bash
$ cast wallet import local_deployer --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
Enter password: # (Hit enter for an empty password)
`local_deployer` keystore was saved successfully. Address: 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
```

### DeployContracts

With single validator
```bash
$ forge script ./script/DeployContracts.s.sol --account local_deployer --password '' --sender 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url local-8545 -vvvv --sig "run(address,address,address,address,address,uint256,uint256,uint256,address[])" 0x88CE2c1d82328f84Dd197f63482A3B68E18cD707 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 100000000000000000 100000000000000000 0 []
```
With multiple validators
```
$ forge script ./script/DeployContracts.s.sol --account local_deployer --password '' --sender 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url local-8545 -vvvv --sig "run(address,address,address,address,address,uint256,uint256,uint256,address[])" 0x88CE2c1d82328f84Dd197f63482A3B68E18cD707 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 100000000000000000 100000000000000000 0 [0xAa1ea8611639537A89Cb5925903Fd1fb28027DE9,0xBB2166dC315dC02F314597eCf867C3dfB45ED205,0xCC0DF974953820B649Bb67F167f01cd265Ea5B0A]
```

### RegisterExternalTokens

```bash
$ forge script ./script/RegisterExternalTokens.s.sol --account local_deployer --password '' --sender 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url local-8545 -vvvv --sig "run()" 
```

### UpdateFeeFactors

```bash
$ forge script ./script/UpdateFeeFactors.s.sol --account local_deployer --password '' --sender 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url local-8545 -vvvv --sig "run(address)"  0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```

### RedeployHub

```bash
$ forge script ./script/redeploy/RedeployHub.s.sol --account local_deployer --password '' --sender 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url local-8545 -vvvv --sig "run(address)" 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```

### UpgradeHub

```bash
$ forge script ./script/redeploy/UpgradeHub.s.sol --account local_deployer --password '' --sender 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url local-8545 -vvvv --sig "run(address)" 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```

### RedeployForwarder

```bash
$ forge script ./script/redeploy/RedeployForwarder.s.sol --account local_deployer --password '' --sender 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url local-8545 -vvvv --sig "run(address)" 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```

### RedeployHubAndForwarder

```bash
$ forge script ./script/redeploy/RedeployHubAndForwarder.s.sol --account local_deployer --password '' --sender 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url local-8545 -vvvv --sig "run(address)" 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```

### UpgradeHubAndRedeployForwarder

```bash
$ forge script ./script/redeploy/UpgradeHubAndRedeployForwarder.s.sol --account local_deployer --password '' --sender 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url local-8545 -vvvv --sig "run(address)" 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```