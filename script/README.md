# Pantos scripts documentation

One can use the Pantos scripts in the following cases:

1. To do a deployment from scratch and initialize the system.
    1. To do a deployment from scratch, use the ```DeployContracts.s.sol``` script.
    2. To register the external tokens, use the ```RegisterExternalTokens.s.sol``` script.
2. To redeploy a contract which is part of the Pantos system.
    1. PantosHub redeployment: If the PantosHub has changes, it is important to understand if those changes lead to storage collision (https://docs.openzeppelin.com/upgrades-plugins/1.x/proxies#storage-collisions-between-implementation-versions).
        1. If the PantosHub suffers storage collision, use the ```redeploy/RedeployHub.s.sol``` script.
        2. If the PantosHub did not suffer storage collision, use the ```redeploy/UpgradeHub.s.sol``` script.
    2. PantosForwarder redeployment. Use the ```redepoy/PantosForwarder.s.sol``` script.
    3. PantosHub and PantosForwarder redeployment (at the same time).
        1. If the PantosHub suffers storage collision, use the ```redeploy/RedeployHubAndForwarder.s.sol``` script.
        2. If the PantosHub did not suffer storage collision, use the ```redeploy/UpgradeHubAndRedeployForwarder.s.sol``` script.
3. To update various parameters of the Pantos system.
    1. To update the fee factors, use the ```UpdateFeeFactors.s.sol``` script.
    2. To update the minimum deposit of the service nodes, use the ```UpdateMinimumDeposit.s.sol``` script.
    3. To update the parameter update delay, use the ```UpdateParameterUpdateDelay.s.sol``` script.
    4. To update the unbonding period of the service nodes deposit, use the ```UpdateUnbondingPeriod.s.sol``` script.
4. To update the validators configuration.
    1. To replace a secondary validator, use the ```ReplaceValidatorNode.s.sol``` script.
    2. To add a secondary validator, use the ```AddValidatorNode.s.sol``` script.
    3. To remove a secondary validator, use the ```RemoveValidatorNode.s.sol``` script.
    4. To update the minimum number of validator nodes required, use the ```SetMinValidatorNodeSignatures.s.sol``` script.
    5. To update the primary validator, use the ```SetPrimaryValidatorNode.s.sol``` script.
5. To manage the Gnosis Safes.
    1. To add an owner, use the ```SafeManagement.s.sol``` script.
    2. To remove an owner, use the ```SafeManagement.s.sol``` script.
    3. To swap an owner, use the ```SafeManagement.s.sol``` script.
    4. To change the threshold, use the ```SafeManagement.s.sol``` script.

## How to run the scripts in a non-local environment

#### Important! Please read before using the scripts in non-local environments:

* Please use the ```--force``` and ```--slow``` options. 
    * The ```--force```option is necessary for clearing the cache of previous deployments on other chains, which might affect new ones. We experienced issues when using the scripts without these options. 
    * The ```--slow``` option is necessary to ensure that previously sent transactions are confirmed before sending new ones.
* If you encounter an error while broadcasting the transactions, please remove the ```--force``` flag and execute the script again with the ```--resume``` option. This can and should be done multiple times (in case of further errors) until all the transactions are successfully broadcasted.
* We keep records of executed scripts in non-local environments at ```./deployment/<env>/<blockchainName>/<executedScript>/```. Each executing should add 2 records: ```run-<YYYYMMDD>.json``` and ```run-<YYYYMMDD>.logs```.
    * The ```.json``` files contains broadcast information automatically generated by ```forge``` when running the scripts. This can be found at ```./broadcast/<executedScript>/<chainId>/run-<identifier>.json```. If the script was executed multiple times using the ```--resume``` flag, one can copy only the latest generated ```run-<identifier>.json``` file (```forge``` automatically merges all the broadcast information into a single file, even if ```--resume``` was used).
    * The ```.logs``` files contain logs generated (in the console) by the executed script. The logs should be copied from the console and pasted into the target file. Please remove any personal information (local user paths) from the logs.

#### Instructions:

1. To run the scripts in a non-local environment, please use the format specified in the ```@dev Usage``` section of the specific script.
2. It is strongly recommended to perform a dry run before broadcasting the transactions. By default, ```forge script``` creates a fork of the blockchain and does a dry run. The scripts emit logs that should be checked before broadcasting the transactions.
3. If the logs are as expected, the transactions can now be broadcasted on the blockchain. In order to achieve this, one needs to add the ```--broadcast``` flag.
4. As a final step, we need to update the ```./deployment/<blockchainName>/<executedScript>/``` records according to the specifications in the above section.

## How to run the scripts in a local environment with Anvil:

The examples run the scripts on a fork of a local blockchain.
* To run the script on a fork of another blockchain, use the flag ```--rpc-url <rpcAlias>```. The aliases can be found in  ```foundry.toml```.
* To broadcast the transactions, use the flag ```--broadcast```.
* To force compilation of all contracts, use the flag ```--force```.

For local testing, one can set up two development blockchains with anvil:

```bash
anvil --port 8545 --chain-id 31337
```
```bash
anvil --port 8546 --chain-id 31338
```

Copy and add one of the private key (always same in default mode) from anvil network terminal and import it as a keystore using cast cli:

```bash
$ cast wallet import local_deployer --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
Enter password: # (Hit enter for an empty password)
`local_deployer` keystore was saved successfully. Address: 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
```

### DeploySafe

Deploy a Gnosis Safe with a single owner:

```bash
$ forge script ./script/DeploySafe.s.sol --account local_deployer --password '' --rpc-url local-8545 -vvvv --sig "deploySafes(address[],uint256,address[],uint256,address[],uint256,address[],uint256)" "[0x8C3229EC621644789d7F61FAa82c6d0E5F97d43D]" 1 "[0x9586A4833970847aef259aD5BFB7aa8901DDf746]" 1 "[0x0e9971c0005D91336c1441b8F03c1C4fe5FB4584]" 1 "[0xC4c81D5C1851702d27d602aA8ff830A7689F17cc]" 1
```

### DeployPanMigrator

Deploy the PAN migrator and all of its dependencies (Access Controller and the new PAN token)

```bash
$ forge script ./script/DeployPanMigrator.s.sol --account local_deployer --password '' --rpc-url local-8545 -vvvv --sig "deploy(address)" 0x536381a8628dBcC8C70aC9A30A7258442eAb4c92
```

### DeployContracts

Deploy all contracts from any gas paying account (on chains where the old PAN does not exist)

```bash
$ forge script ./script/DeployContracts.s.sol --account local_deployer --password '' --rpc-url local-8545 -vvvv --sig "deploy(uint256,uint256)" 100000000000000000 100000000000000000
```

Deploy the remaining contracts from any gas paying account (on chains where the old PAN, new PAN, Access Controller, and the PAN migrator exist)

```bash
forge script ./script/DeployContracts.s.sol --account local_deployer --password '' --rpc-url local-8545 -vvvv --sig "deploy(uint256)" 100000000000000000 --broadcast
```

RoleActions for all deployed contracts (simulation only!)

With single validator

```bash
$ forge script ./script/DeployContracts.s.sol --rpc-url local-8545 -vvvv --sig "roleActions(uint256,uint256,address,address[])" 0 1 0x88CE2c1d82328f84Dd197f63482A3B68E18cD707 []
```

With multiple validators

```bash
$ forge script ./script/DeployContracts.s.sol --rpc-url local-8545 -vvvv --sig "roleActions(uint256,uint256,address,address[])" 0 3 0x88CE2c1d82328f84Dd197f63482A3B68E18cD707 [0xAa1ea8611639537A89Cb5925903Fd1fb28027DE9,0xBB2166dC315dC02F314597eCf867C3dfB45ED205,0xCC0DF974953820B649Bb67F167f01cd265Ea5B0A]
```

### SubmitSafeTxs

```bash
$ forge script ./script/SubmitSafeTxs.s.sol --account local_deployer --password '' --rpc-url local-8545  -vvvv --sig "run()"
```

### RegisterExternalTokens

```bash
$ forge script ./script/RegisterExternalTokens.s.sol --rpc-url local-8545 -vvvv --sig "roleActions()"
```

### UpdateFeeFactors

```bash
$ forge script ./script/update/parameters/UpdateFeeFactors.s.sol --rpc-url local-8545 -vvvv --sig "roleActions()"
```

### UpdateMinimumDeposit

```bash
$ forge script ./script/update/parameters/UpdateMinimumDeposit.s.sol --rpc-url local-8545 -vvvv --sig "roleActions(uint256)" 1
```

### UpdateParameterUpdateDelay

```bash
$ forge script ./script/update/parameters/UpdateParameterUpdateDelay.s.sol --rpc-url local-8545 -vvvv --sig "roleActions(uint256)" 1
```

### UpdateUnbondingPeriod

```bash
$ forge script ./script/update/parameters/UpdateUnbondingPeriod.s.sol --rpc-url local-8545 -vvvv --sig "roleActions(uint256)" 1
```

### ReplaceValidatorNode

```bash
$ forge script ./script/update/validators/ReplaceValidatorNode.s.sol --rpc-url local-8545 -vvvv --sig "roleActions(address,address)" 0x9E7c67F9DE01a9ff5547f172a7d1119E62214667 0xA93937e73B964B81eac024cBB38626bA972ee986
```

### AddValidatorNode

```bash
$ forge script ./script/update/validators/AddValidatorNode.s.sol --rpc-url local-8545 -vvvv --sig "roleActions(address)" 0x9E7c67F9DE01a9ff5547f172a7d1119E62214667
```

### RemoveValidatorNode

```bash
$ forge script ./script/update/parameters/RemoveValidatorNode.s.sol --rpc-url local-8545 -vvvv --sig "roleActions(address)" 0x9E7c67F9DE01a9ff5547f172a7d1119E62214667
```

### SetMinValidatorNodeSignatures

```bash
$ forge script ./script/update/validators/SetMinValidatorNodeSignatures.s.sol --rpc-url local-8545 -vvvv --sig "roleActions(uint256)" 5
```

### SetPrimaryValidatorNode

```bash
$ forge script ./script/update/validators/SetPrimaryValidatorNode.s.sol --rpc-url local-8545 -vvvv --sig "roleActions(address)" 0x9E7c67F9DE01a9ff5547f172a7d1119E62214667
```

### AddOwnerWithThreshold

```bash
$ forge script ./script/safes/SafeManagement.s.sol --rpc-url local-8545 -vvvv --sig "addOwnerWithThreshold(string,address,uint256)" super_critical_ops 0xd7a2bFf702D86394D79D791E12212B26dCaC834f 1
```

### RemoveOwnerWithThreshold

```bash
$ forge script ./script/safes/SafeManagement.s.sol --rpc-url local-8545 -vvvv --sig "removeOwnerWithThreshold(string,address,uint256)" super_critical_ops 0xd7a2bFf702D86394D79D791E12212B26dCaC834f 1
```

### SwapOwner

```bash
$ forge script ./script/safes/SafeManagement.s.sol --rpc-url local-8545 -vvvv --sig "swapOwner(string,address,address)" super_critical_ops 0xd7a2bFf702D86394D79D791E12212B26dCaC834f 0xE9c98b78b7714a6bcdD93f2F0e7A54B362BEa6cd 
```

### ChangeThreshold

```bash
$ forge script ./script/safes/SafeManagement.s.sol --rpc-url local-8545 -vvvv --sig "changeThreshold(string,uint256)" super_critical_ops 2
```


### RedeployHub

Deploy all contracts from any gas paying account

```bash
$ forge script ./script/redeploy/RedeployHub.s.sol --account local_deployer --password '' --rpc-url local-8545 -vvvv --sig "deploy(address)" 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0

```

RoleActions for all redeployed contracts (simulation only!)

```bash
forge script ./script/redeploy/RedeployHub.s.sol --rpc-url local-8545 -vvvv --sig "roleActions()"
```


### UpgradeHub

Deploy all facet contracts from any gas paying account

```bash
$ forge script ./script/redeploy/UpgradeHub.s.sol --account local_deployer --password '' --rpc-url local-8545 -vvvv --sig "deploy()"
```

RoleActions for all redeployed contracts (simulation only!)

```bash
forge script ./script/redeploy/UpgradeHub.s.sol --rpc-url local-8545 -vvvv --sig "roleActions()"
```

### RedeployForwarder
Deploy new contracts from any gas paying account

```bash
forge script ./script/redeploy/RedeployForwarder.s.sol --account local_deployer --password '' --rpc-url local-8545 -vvvv --sig "deploy(address)" 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```
RoleActions for all redeployed contracts (simulation only!)
```bash
forge script ./script/redeploy/RedeployForwarder.s.sol --rpc-url local-8545 -vvvv --sig "roleActions()"
```

### RedeployHubAndForwarder

Deploy new contracts from any gas paying account

```bash
$ forge script ./script/redeploy/RedeployHubAndForwarder.s.sol --account local_deployer --password '' --rpc-url local-8545 -vvvv --sig "deploy(address)" 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```
RoleActions for all redeployed contracts (simulation only!)
```bash
forge script ./script/redeploy/RedeployHubAndForwarder.s.sol --rpc-url local-8545 -vvvv --sig "roleActions()"
```

### UpgradeHubAndRedeployForwarder

```bash
forge script ./script/redeploy/UpgradeHubAndRedeployForwarder.s.sol --account local_deployer --password '' --rpc-url local-8545 -vvvv --sig "deploy(address)" 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```

RoleActions for all redeployed contracts (simulation only!)

```bash
forge script ./script/redeploy/UpgradeHubAndRedeployForwarder.s.sol --rpc-url local-8545 -vvvv --sig "roleActions()"
```
